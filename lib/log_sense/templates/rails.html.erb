<!doctype html>
<html class="no-js" lang="en">
  <head>
    <title><%= options[:title] || "Log Sense: #{data[:log_file]}" %></title>

    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Log Sense">
    <meta name="description" content="Analysis of <%= data[:log_file] %>">

    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
    <link href="https://fonts.googleapis.com/css2?family=PT+Sans&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundicons/3.0.0/foundation-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/foundation-sites@6.7.4/dist/css/foundation.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/zf/dt-1.11.3/datatables.min.css"/>


    <script src="https://cdn.jsdelivr.net/npm/vega@5.21.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.20.2"></script>

    <style>
     body {
       font-family: 'PT Sans', sans-serif;
       font-size: 80%;
     }

     #offCanvas {
       color: white;
       background: #0D0630;
       border-right: none;
       box-shadow: none;
       padding: 0.5rem;
     }
     #offCanvas a {
       color: #E6F9AF;
     }

     .contents-button {
       font-size: xx-large;
     }

     .main-section {
       margin-left: 45px;
     }

     h1 {
       font-size: 1.8rem;
     }

     h2 {
       font-size: 1.2rem;
     }

     th {
       padding: 0.2rem 1.2rem 0.2rem 0.2rem !important
     }

     td {
       padding: 0.2rem 1rem 0.2rem 0.2rem !important;
     }

     .hits, .visits, .size, .count, .s2xx, .s3xx, .so4xx, .total-hits, .total-visits {
       text-align: right !important;
     }

     .card-divider {
       padding: 0.2rem 0.4rem 0.2rem 0.4rem;
       background: #D30001;
       color: white;
     }

     input, select {
       font-size: 0.8rem !important;
       height: 1.5rem !important;
       padding: 0.2rem 0.4rem 0.2rem 0.4rem !important;
     }

     .dataTables_info {
       font-size: small;
       color: rgb(202, 202, 202);
     }

     ul.pagination, li.paginate_button {
       font-size: small;
       margin-top: 0px !important;
       margin-bottom: 0px !important;
       padding-top: 0px !important;
       padding-bottom: 0px !important;
     }

     .stats-list {
       list-style-type: none;
       clear: left;
       margin: 0;
       padding: 0;
       text-align: center;
       margin-bottom: 30px;
     }

     .stats-list .stats-list-positive {
       color: #228b22;
     }

     .stats-list .stats-list-negative {
       color: #a52a2a;
     }

     .stats-list > li {
       display: inline-block;
       margin-right: 10px;
       padding-right: 10px;
       border-right: 1px solid #cacaca;
       text-align: center;
       font-size: 1.1em;
       font-weight: bold;
     }

     .stats-list > li:last-child {
       border: none;
       margin: 0;
       padding: 0;
     }

     .stats-list > li .stats-list-label {
       display: block;
       margin-top: 2px;
       font-size: 0.9em;
       font-weight: normal;
     }

     #streaks-table .ip {
       vertical-align: top;
     }
     #streaks-table .date {
       font-weight: bold;
     }
     #streaks-table .res-title {
       font-decoration: underline;
     }
    </style>

  </head>

  <body>
    <div class="off-canvas-wrapper">
      <div class="off-canvas position-left" id="offCanvas" data-off-canvas>
        <nav>
          <h2>Navigation</h2>
          <ul class="no-bullet">
            <% [
              "Summary",
              "Log Structure",
              "Daily Distribution",
              "Time Distribution",
              "Statuses",
              "Rails Performance",
              "Fatal Events",
              "Internal Server Errrors",
              "Errors",
              "IPs",
              "Command Invocation",
              "Performance"
            ].each do |item| %>
              <li class="nav-item">
                <a href="#<%= item.downcase.gsub(' ', '-') %>" data-close><%= item %></a>
              </li>
            <% end %>
          </ul>

          <p>
            Generated by
            <a href="https://github.com/avillafiorita/log_sense">LogSense</a> <br />
            on <%= DateTime.now.strftime("%Y-%m-%d %H:%M") %>.<br />
            <a href='https://db-ip.com'>IP Geolocation by DB-IP</a>
          </p>
        </nav>
      </div>
      <div class="off-canvas-content grid-container grid-x fluid" data-off-canvas-content>
        <div data-sticky-container>
          <div class="sticky" data-sticky data-margin-top="0">
            <div class="contents-button">
              <i id="hamburger" class="fi-list" data-toggle="offCanvas"></i>
            </div>
          </div>
        </div>

        <section class="main-section">
          <h1><%= options[:title] || "Log Sense: #{data[:log_file]}" %></h1>

          <p><b>Input File:</b>  <%= (data[:log_file] || "stdin") %></p>

          <div class="grid-x grid-margin-x">
            <article class="card small-12 large-6 cell">
              <div class="card-divider">
                <h2 id="summary">Summary</h2>
              </div>
              <div class="card-section">
                <%= render "summary.html.erb", data: data %>
              </div>
            </article>

            <article class="card cell small-12 large-6">
              <div class="card-divider">
                <h2 id="log-structure">Log Structure</h2>
              </div>
              <div class="card-section">
                <%= render "log_structure.html.erb", data: data %>
              </div>
            </article>
          </div>

          <% @reports = [
            { title: "Daily Distribution",
              header: ["Day", "DOW", "Hits"],
              rows: data[:daily_distribution],
              vega_spec: {
                "encoding": {
                  "x": {"field": "Day", "type": "temporal"},
                  "y": {"field": "Hits", "type": "quantitative"}
                },
                "layer": [
                  {
                    "mark": {
                      "type": "line",
                      "point": {
                        "filled": false,
                        "fill": "white"
                      }
                    }
                  },
                  {
                    "mark": {
                      "type": "text",
                      "align": "left",
                      "baseline": "middle",
                      "dx": 5
                    },
                    "encoding": {
                      "text": {"field": "Hits", "type": "quantitative"}
                    }
                  }
                ]
              }
            },
            { title: "Time Distribution",
              header: ["Hour", "Hits"],
              rows: data[:time_distribution],
              vega_spec: {
                "layer": [
                  {
                    "mark": "bar",
                  },
                  {
                    "mark": {
                      "type": "text",
                      "align": "middle",
                      "baseline": "top",
                      "dx": -10,
                      "yOffset": -15
                    },
                    "encoding": {
                      "text": {"field": "Hits", "type": "quantitative"}
                    }
                  }
                ],
                "encoding": {
                  "x": {"field": "Hour", "type": "nominal"},
                  "y": {"field": "Hits", "type": "quantitative"}
                }
              }
            },
            { title: "Statuses",
              header: ["Status", "Count"],
              rows: data[:statuses],
              vega_spec: {
                "layer": [
                  {
                    "mark": "bar"
                  },
                  {
                    "mark": {
                      "type": "text",
                      "align": "left",
                      "baseline": "top",
                      "dx": -10,
                      "yOffset": -20
                    },
                    "encoding": {
                      "text": {"field": "Count", "type": "quantitative"}
                    }
                  }
                ],
                "encoding": {
                  "x": {"field": "Status", "type": "nominal"},
                  "y": {"field": "Count", "type": "quantitative"}
                }
              }
            },
            { title: "Rails Performance",
              header: ['Controller', 'Hits', 'Min', 'Avg', 'Max'],
              rows: @data[:performance],
              vega_spec: {
                "layer": [
                  {
                    "mark": "point"
                  },
                ],
                "encoding": {
                  "x": {"field": "Avg", "type": "quantitative"},
                  "y": {"field": "Hits", "type": "quantitative"}
                },
              }
            },
            { title: "Fatal Events",
              header: ['Date', 'IP', 'URL', 'Description', 'Log ID'], rows: @data[:fatal],
              col: "small-12 cell"
            },
            { title: "Internal Server Errors",
              header: ['Date', 'Status', 'IP', 'URL', 'Description', 'Log ID'], rows: @data[:internal_server_error],
              col: "small-12 cell"
            },
            { title: "Errors",
              header: ['Log ID', 'Context', 'Description', 'Count'], rows: @data[:error],
              col: "small-12 cell"
            },
            { title: "IPs",
              header: ["IPs", "Hits", "Country"],
              rows: data[:ips]
            },
          ]
          %>
          <div class="grid-x grid-margin-x">
            <% @reports.each_with_index do |report, index| %>
              <article class="card cell <%= report[:col] || "small-12 large-6" %>" >
                <div class="card-divider">
                  <h2>
                    <%= report[:title] %>
                  </h2>
                </div>

                <% if report[:vega_spec] %>
                  <div id="<%= "plot-#{index}" %>"></div>
                  <script>
                   plot_spec_<%= index %> = Object.assign(
                     <%= report[:vega_spec].to_json %>,
                     { "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                       width: "container",
                       description: "<%= report[:title] %>",
                       data: {
                         values: [
                           <% report[:rows].each do |row| %>
                           {
                             <% report[:header].each_with_index do |h, i| %>
                             "<%= h %>": <%= (row[i].class == Integer or row[i].class == Float) ? row[i] : "\"#{row[i]}\"" %>,
                             <% end %>
                           },
                           <% end %>
                         ]
                       },
                   });
                   vegaEmbed('#<%= "plot-#{index}"%>', plot_spec_<%= index %>);
                  </script>
                <% end %>
                <div class="card-section">
                  <%= render "output_table.html.erb", report %>
                </div>
              </article>
            <% end %>
          </div>

          <div class="grid-x grid-margin-x">
            <div class="cell small-12 large-6">
              <article>
                <h2 id="command-invocation">Command Invocation</h2>

                <%= render "command_invocation.html.erb", data: data, options: options %>
              </article>
            </div>

            <div class="small-12 large-6 cell">
              <article>
                <h2 id="performance"> Performance</h2>

                <%=  render "performance.html.erb", data: data %>
              </article>
            </div>
          </div>
        </section>
      </div>

      <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <script type="text/javascript" src="js/vendor/what-input.js"></script>
      <script type="text/javascript" src="https://cdn.datatables.net/v/zf/dt-1.11.3/datatables.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>    
      <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/foundation-sites@6.7.4/dist/js/foundation.min.js" crossorigin="anonymous"></script>
      <script>
       $(document).foundation();

       $(document).ready(function () {
         $('.data-table').each(function () {
           $(this).DataTable();
         });
       });
      </script>
    </div>
  </body>
</html>
