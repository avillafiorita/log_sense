<!doctype html>
<html class="no-js" lang="en">
  <head>
    <title>Log Sense: <%= data[:log_file] %></title>

    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Log Sense">
    <meta name="description" content="Analysis of <%= data[:log_file] %>">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundicons/3.0.0/foundation-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/foundation-sites@6.7.4/dist/css/foundation.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/zf/dt-1.11.3/datatables.min.css"/>

    <style>
     #offCanvas {
       color: white;
       background: #333333;
       border-right: ;
       box-shadow: none;
       padding: 0.5rem;
     }
     #offCanvas a {
       color: orange;
     }

     .contents-button {
       font-size: xx-large;
     }

     .main-section {
       margin-left: 45px;
     }

    </style>

  </head>

  <body>
    <div class="off-canvas-wrapper">
      <div class="off-canvas position-left" id="offCanvas" data-off-canvas>
        <nav>
          <h2>Navigation</h2>
          <ul class="no-bullet">
                <% [ "Summary",
                  "Log Structure",
                  "Daily Distribution",
                  "Time Distribution",
                  "Most Requested Pages",
                  "Most Requested Resources",
                  "404 on HTML Files",
                  "404 on other Resources",
                  "Attacks",
                  "Statuses",
                  "Daily Statuses",
                  "Browsers",
                  "Platforms",
                  "Referers",
                  "IPs",
                  "Geolocation",
                  "Streaks",
                  "Command Invocation",
                  "Performance"
            ].each do |item| %>
                  <li class="nav-item">
                    <a href="#<%= item.downcase.gsub(' ', '-') %>" data-close><%= item %></a>
              </li>
            <% end %>
          </ul>

          <p>
            Generated by
            <a href="https://github.com/avillafiorita/log_sense">LogSense</a> <br />
            on <%= DateTime.now.strftime("%Y-%m-%d %H:%M") %>.<br />
            <a href='https://db-ip.com'>IP Geolocation by DB-IP</a>
          </p>
        </nav>
      </div>
      <div class="off-canvas-content grid-container grid-x fluid" data-off-canvas-content>
        <div data-sticky-container>
          <div class="sticky" data-sticky data-margin-top="0">
            <div class="contents-button">
              <i id="hamburger" class="fi-list" data-toggle="offCanvas"></i>
            </div>
          </div>
        </div>

        <section class="main-section">
          <h1>Apache Log Analysis: <%= data[:log_file] || "stdin" %></h1>

          <div class="grid-x grid-margin-x">
            <article class="small-12 large-6 cell">
              <h2 id="summary">Summary</h2>
              <%= render "summary.html.erb", data: data %>
            </article>

            <article class="cell small-12 large-6">
              <h2 id="log-structure">Log Structure</h2>
              <%= render "total_hits.html.erb", data: data %>
            </article>
          </div>

          <% @reports = [
            { title: "Daily Distribution", header: ["Day", "DOW", "Hits", "Visits", "Size"], rows: data[:daily_distribution] },
            { title: "Time Distribution",  header: ["Hour", "Hits", "Visits", "Size"], rows: data[:time_distribution] },
            { title: "Most Requested Pages", header: ["Path", "Hits", "Visits", "Size"], rows: data[:most_requested_pages] },
            { title: "Most Requested Resources", header: ["Path", "Hits", "Visits", "Size"], rows: data[:most_requested_resources] },
            { title: "404 on HTML Files", header: ["Path", "Hits", "Visits"], rows: data[:missed_pages] },
            { title: "404 on other Resources", header: ["Path", "Hits", "Visits"], rows: data[:missed_resources] },
            { title: "Attacks", header: ["Path", "Hits", "Visits"], rows: data[:attacks] },
            { title: "Statuses", header: ["Status", "Count"], rows: data[:statuses] },
            { title: "Daily Statuses", header: ["Status", "2xx", "3xx", "4xx"], rows: data[:statuses_by_day] },
            { title: "Browsers", header: ["Browser", "Hits", "Visits", "Size"], rows: data[:browsers] },
            { title: "Platforms", header: ["Platform", "Hits", "Visits", "Size"], rows: data[:platforms] },
            { title: "Referers", header: ["Referers", "Hits", "Visits", "Size"], rows: data[:referers], col: "col-12" },
            { title: "IPs", header: ["IPs", "Hits", "Visits", "Size", "Country"], rows: data[:ips] },
          ]
          %>
          <div class="grid-x grid-margin-x">
            <% @reports.each do |report| %>
              <article class="cell <%= report[:col] || "small-12 large-6" %>" >
                <h2 id="<%= report[:title].downcase.gsub(/ +/, '-') %>">
                  <%= report[:title] %>
                </h2>
                <%= render "output_table.html.erb", report %>
              </article>
            <% end %>
          </div>

          <article>
            <h2 id="geolocation">Geolocation</h2>
            <table id="geolocation-table" class="table unstriped">
              <thead>
                <tr>
                  <th>Country Code</th>
                  <th>Total Hits</th>
                  <th>Total Visits</th>
                  <th>IPs</th>
                </tr>              
              </thead>
              <tbody>
                <%# IP, Hits, Visits Size, Country%>
                <% data[:ips].group_by { |x| x[4] }.each do |k, v| %>
                  <tr>
                    <td><%= k %></td>
                    <td><%= v.map { |x| x[1] }.inject(&:+) %></td>
                    <td><%= v.map { |x| x[2] }.inject(&:+) %></td>
                    <td><%= v.map { |x| x[0] }.join(", ") %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </article>

          <article>
            <h2 id="streaks">Streaks</h2>

            <table id="streaks-table" class="table data-table streaks">
              <thead>
                <tr>
                  <th>IP</th>
                  <th>
                    <div class="grid-x grid-margin-x">
                      <div class="col-2 cell">
                        Day
                      </div>
                      <div class="col-10 cell">
                        Resources
                      </div>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody>
                <% data[:streaks].group_by(&:first).each do |ip, date_urls| %>
                  <tr>
                    <td class="ip"><%= ip %></td>
                    <td class="streaks">
                      <div class="grid-x grid-margin-x">
                        <% date_urls.group_by { |x| x[1] }.each do |date, urls| %>
                          <div class="col-2 cell">
                            <%= date %>
                          </div>
                          <div class="col-10 cell">
                            <span class="res-title">HTML:</span>
                            <ul>
                              <% urls.map { |x| x[2] }.compact.select { |x| x.match /.*\.html?/ }.each do |url| %>
                                <li><%= url %></li>
                              <% end %>
                            </ul>
                            
                            <span class="res-title">Other Resources:</span>
                            <ul>
                              <% urls.map { |x| x[2] }.compact.sort.select { |x| x and not x.match /.*\.html?/ }.each do |url| %>
                                <li><%= url %></li>
                              <% end %>
                            </ul>
                          </div>
                        <% end %>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </article>

          <div class="grid-x grid-margin-x">
            <div class="cell small-12 large-6">
              <article>
                <h2 id="command-invocation">Command Invocation</h2>

                <%= render "command_invocation.html.erb", data: data, options: options %>
              </article>
            </div>

            <div class="small-12 large-6 cell">
              <article>
                <h2 id="performance"> Performance</h2>

                <%=  render "performance.html.erb", data: data %>
              </article>
            </div>
          </div>
        </section>
      </div>

      <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <script type="text/javascript" src="js/vendor/what-input.js"></script>
      <script type="text/javascript" src="https://cdn.datatables.net/v/zf/dt-1.11.3/datatables.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>    
      <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/foundation-sites@6.7.4/dist/js/foundation.min.js" crossorigin="anonymous"></script>
      <script>
       $(document).foundation();

       $(document).ready(function () {
         $('.data-table').each(function () {
           $(this).DataTable();
         });
       });
      </script>
    </div>
  </body>
</html>
