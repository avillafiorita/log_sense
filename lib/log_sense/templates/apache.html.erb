<html>
  <head>
    <title>Apache Log Analysis: <%= data[:log_file] || "stdin" %></title>
    <meta name="author" content="apache_log_report">

    <link rel="stylesheet" href="alr-styles.css"></style>

    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">
  </head>

  <body>
    <div class="container">
      <nav>
        <ul class="nav">
          <li class="nav-item active">
            <a href="#">Navigation</a>
            <ul class="nav">
              <% [ "Summary",
                "Log Structure",
                "Daily Distribution",
                "Time Distribution",
                "Most Requested Pages",
                "Most Requested Resources",
                "404 on HTML Files",
                "404 on other Resources",
                "Attacks",
                "Statuses",
                "Daily Statuses",
                "Browsers",
                "Platforms",
                "Referers",
                "IPs",
                "Geolocation",
                "Streaks",
                "Command Invocation",
                "Performance"
              ].each do |item| %>
                <li class="nav-item">
                  <a href="#<%= item.downcase.gsub(' ', '-') %>"><%= item %></a>
                </li>
              <% end %>
            </ul>
          </li>
        </ul>
        <p>
          Generated by<br />
          <a href="https://github.com/avillafiorita/log_sense">LogSense</a> <br />
          on <%= DateTime.now.strftime("%Y-%m-%d %H:%M") %>.<br />
          <a href='https://db-ip.com'>IP Geolocation by DB-IP</a>
        </p>
      </nav>

      <section>
        <h1>Apache Log Analysis: <%= data[:log_file] || "stdin" %></h1>

        <div class="columns">
          <article class="col-6 column">
            <h2 id="summary">Summary</h2>

            <table class="table summary">
              <tr>
                <th>Input file</th>
                <td><b><%= (data[:log_file] || "stdin") %></b></td>
              </tr>
              <tr>
                <th class="period">Period Analyzed</th>
                <td class="period">
                  <%= data[:first_day_in_analysis] %>
                  --
                  <%= data[:last_day_in_analysis] %>
                </td>
              </tr>
              <tr>
                <th class="days">Days </th>
                <td class="days"><%= data[:total_days_in_analysis] %></td>
              </tr>
              <tr>
                <th class="hits">Hits</th>
                <td class="hits"><%= data[:total_hits][0][0] %></td>
              </tr>
              <tr>
                <th class="unique-visitors">Unique Visitors</th>
                <td class="unique-visitors"><%= data[:total_unique_visitors][0][0] %></td>
              </tr>
              <tr>
                <th class="tx">Tx</th>
                <td class="tx"><%= data[:total_size][0][0] %></td>
              </tr>
            </table>
          </article>
          <article class="column col-6">
            <h2 id="log-structure">Log Structure</h2>

            <table class="table log-structure">
              <tbody>
                <tr>
                  <th>Input file</th>
                  <td><b><%= (data[:log_file] || "stdin") %></b></td>
                </tr>
                <tr>
                  <th>Period in Log</th>
                  <td><%= data[:first_day] %> -- <%= data[:last_day] %></td>
                </tr>
                <tr>
                  <th>Total days</th>
                  <td><%= data[:total_days] %></td>
                </tr>
                <tr>
                  <th>Log size</th>
                  <td><%= data[:log_size][0][0] %></td>
                </tr>
                <tr>
                  <th>Self poll entries</th>
                  <td><%= data[:selfpolls_size][0][0] %></td>
                </tr>
                <tr>
                  <th>Crawlers</th>
                  <td><%= data[:crawlers_size][0][0] %></td>
                </tr>
                <tr>
                  <th>Entries considered</th>
                  <td><%= data[:total_hits][0][0] %></td>
                </tr>
              </tbody>
            </table>
          </article>
        </div>

        <% @reports = [
          { title: "Daily Distribution", header: ["Day", "DOW", "Hits", "Visits", "Size"], rows: data[:daily_distribution] },
          { title: "Time Distribution",  header: ["Hour", "Hits", "Visits", "Size"], rows: data[:time_distribution] },
          { title: "Most Requested Pages", header: ["Path", "Hits", "Visits", "Size"], rows: data[:most_requested_pages] },
          { title: "Most Requested Resources", header: ["Path", "Hits", "Visits", "Size"], rows: data[:most_requested_resources] },
          { title: "404 on HTML Files", header: ["Path", "Hits", "Visitors"], rows: data[:missed_pages] },
          { title: "404 on other Resources", header: ["Path", "Hits", "Visitors"], rows: data[:missed_resources] },
          { title: "Attacks", header: ["Path", "Hits", "Visitors"], rows: data[:attacks] },
          { },
          { title: "Statuses", header: ["Status", "Count"], rows: data[:statuses] },
          { title: "Daily Statuses", header: ["Status", "2xx", "3xx", "4xx"], rows: data[:statuses_by_day] },
          { title: "Browsers", header: ["Browser", "Hits", "Visitors", "Size"], rows: data[:browsers] },
          { title: "Platforms", header: ["Platform", "Hits", "Visitors", "Size"], rows: data[:platforms] },
          { title: "Referers", header: ["Referers", "Hits", "Visitors", "Size"], rows: data[:referers], col: "col-12" },
          { title: "IPs", header: ["IPs", "Hits", "Visitors", "Size", "Country"], rows: data[:ips] },
          { },
        ]
        %>
        <div class="columns">
          <% @reports.each do |report| %>
            <div class="column <%= report[:col] || "col-6" %>">
              <article>
                <% if report[:title] != nil %>
                  <h2 id="<%= report[:title].downcase.gsub(/ +/, '-') %>">
                    <%= report[:title] %>
                  </h2>
                  <%= render "output_table", report %>
                <% end %>
              </article>
            </div>
          <% end %>
        </div>

        <article>
          <h2 id="geolocation">Geolocation</h2>
          <table class="table">
            <thead>
              <tr>
                <th>Country Code</th>
                <th>Total Hits</th>
                <th>Total Visitors</th>
                <th>IPs</th>
              </tr>              
            </thead>
            <tbody>
              <%# IP, Hits, Visitors Size, Country%>
              <% data[:ips].group_by { |x| x[4] }.each do |k, v| %>
                <tr>
                  <td><%= k %></td>
                  <td><%= v.map { |x| x[1] }.inject(&:+) %></td>
                  <td><%= v.map { |x| x[2] }.inject(&:+) %></td>
                  <td><%= v.map { |x| x[0] }.join(", ") %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </article>

        <article>
          <h2 id="streaks">Streaks</h2>

          <table class="table streaks">
            <thead>
              <tr>
                <th>IP</th>
                <th>
                  <div class="columns">
                    <div class="col-2 column">
                      Day
                    </div>
                    <div class="col-10 column">
                      Resources
                    </div>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody>
              <% data[:streaks].group_by(&:first).each do |ip, date_urls| %>
                <tr>
                  <td class="ip"><%= ip %></td>
                  <td class="streaks">
                    <div class="columns">
                    <% date_urls.group_by { |x| x[1] }.each do |date, urls| %>
                      <div class="col-2 column">
                        <%= date %>
                      </div>
                      <div class="col-10 column">
                        <span class="res-title">HTML:</span>
                        <ul>
                          <% urls.map { |x| x[2] }.select { |x| x and x.match /.*\.html?/ }.each do |url| %>
                            <li><%= url %></li>
                          <% end %>
                        </ul>
                        
                        <span class="res-title">Other Resources:</span>
                        <ul>
                          <% urls.map { |x| x[2] }.sort.select { |x| x and not x.match /.*\.html?/ }.each do |url| %>
                            <li><%= url %></li>
                          <% end %>
                        </ul>
                      </div>
                    <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </article>

        <div class="columns">
          <div class="column col-6">
            <article>
              <h2 id="command-invocation">Command Invocation</h2>

              <table class="table command-invocation">
                <tbody>
                  <tr>
                    <th>CLI Command</th>
                    <td><code><%= data[:command] %></code></td>
                  </tr>
                  <tr>
                    <th>Input file</th>
                    <td><code><%= (data[:log_file] || "stdin") %></code></td>
                  </tr>
                  <tr>
                    <th>Ignore crawlers</th>
                    <td><code><%= options[:ignore_crawlers] %></code></td></tr>
                  <tr>
                    <th>Only crawlers</th>
                    <td><code><%= options[:only_crawlers] %></code></td>
                  </tr>
                  <tr>
                    <th>No selfpoll</th>
                    <td><code><%= options[:no_selfpoll] %></code></td>
                  </tr>
                  <tr>
                    <th>Filter by date</th>
                    <td>
                      <code><%= (options[:from_date] != nil or options[:to_date] != nil) %></code>
                    </td>
                  </tr>
                  <tr>
                    <th>Prefix</th>
                    <td><code><%= @prefix %></code></td>
                  </tr>
                  <tr>
                    <th>Suffix</th>
                    <td><code><%= @suffix %></code></td>
                  </tr>
                </tbody>
              </table>
            </article>
          </div>

          <div class="column col-6">
            <article>
              <h2 id="performance"> Performance</h2>

              <table class="table performance">
                <tbody>
                  <tr>
                    <th>Analysis started at</th>
                    <td><%= data[:started_at].to_s %></td>
                  </tr>
                  <tr>
                    <th>Analysis ended at</th>
                    <td><%= data[:ended_at].to_s %></td>
                  </tr>
                  <tr>
                    <th>Duration (sec)</th>
                    <td><%= "%.1f" % data[:duration]  %></td>
                  </tr>
                  <tr>
                    <th>Duration (min)</th>
                    <td><%= "%d" % (data[:duration] / 60 ) %></td>
                  </tr>
                  <tr>
                    <th>Log size</th>
                    <td><%= data[:log_size][0][0] %></td>
                  </tr>
                  <tr>
                    <th>Lines/sec</th>
                    <td><%= "%.2f" % (data[:log_size][0][0] / data[:duration]) %></td></tr>
                </tbody>
              </table>
            </article>
          </div>
        </div>
      </section>
    </div>
  </body>
</html>




