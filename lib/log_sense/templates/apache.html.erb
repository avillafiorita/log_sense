<!doctype html>
<html class="no-js" lang="en">
  <head>
    <title><%= options[:title] || "Log Sense: #{data[:log_file]}" %></title>

    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Log Sense">
    <meta name="description" content="Analysis of <%= data[:log_file] %>">

    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
    <link href="https://fonts.googleapis.com/css2?family=PT+Sans&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundicons/3.0.0/foundation-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/foundation-sites@6.7.4/dist/css/foundation.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/zf/dt-1.11.3/datatables.min.css"/>

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/zf/dt-1.11.3/datatables.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/vega@5.21.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.20.2"></script>

    <style>
     body {
       font-family: 'PT Sans', sans-serif;
       font-size: 80%;
     }

     #offCanvas {
       color: #DEDEDE;
       background: #1C1C1C;
       border-right: none;
       box-shadow: none;
       padding: 0.5rem;
     }
     #offCanvas a {
       color: #FFFFFF;
     }

     .contents-button {
       font-size: xx-large;
     }

     .main-section {
       margin-left: 45px;
     }

     h1 {
       font-size: 1.8rem;
     }

     h2 {
       font-size: 1.2rem;
     }

     th {
       padding: 0.2rem 1.2rem 0.2rem 0.2rem !important
     }

     td {
       padding: 0.2rem 1rem 0.2rem 0.2rem !important;
     }

     .hits, .visits, .size, .count, .s2xx, .s3xx, .so4xx, .total-hits, .total-visits {
       text-align: right !important;
     }

     .card-divider {
       padding: 0.2rem 0.4rem 0.2rem 0.4rem;
       background: #1C1C1C;
       color: white;
     }

     input, select {
       font-size: 0.8rem !important;
       height: 1.5rem !important;
       padding: 0.2rem 0.4rem 0.2rem 0.4rem !important;
     }

     .dataTables_info {
       font-size: small;
       color: rgb(202, 202, 202);
     }

     ul.pagination, li.paginate_button {
       font-size: small;
       margin-top: 0px !important;
       margin-bottom: 0px !important;
       padding-top: 0px !important;
       padding-bottom: 0px !important;
     }

     .stats-list {
       list-style-type: none;
       clear: left;
       margin: 0;
       padding: 0;
       text-align: center;
       margin-bottom: 30px;
     }

     .stats-list .stats-list-positive {
       color: #228b22;
     }

     .stats-list .stats-list-negative {
       color: #a52a2a;
     }

     .stats-list > li {
       display: inline-block;
       margin-right: 10px;
       padding-right: 10px;
       border-right: 1px solid #cacaca;
       text-align: center;
       font-size: 1.1em;
       font-weight: bold;
     }

     .stats-list > li:last-child {
       border: none;
       margin: 0;
       padding: 0;
     }

     .stats-list > li .stats-list-label {
       display: block;
       margin-top: 2px;
       font-size: 0.9em;
       font-weight: normal;
     }

     #streaks-table .ip {
       vertical-align: top;
     }
     #streaks-table .date {
       font-weight: bold;
     }
     #streaks-table .res-title {
       font-decoration: underline;
     }
    </style>

  </head>

  <body>
    <div class="off-canvas-wrapper">
      <div class="off-canvas position-left" id="offCanvas" data-off-canvas>
        <nav>
          <h2>Navigation</h2>
          <ul class="no-bullet">
                <% [ "Summary",
                  "Log Structure",
                  "Daily Distribution",
                  "Time Distribution",
                  "20_ and 30_ on HTML pages",
                  "20_ and 30_ on other resources",
                  "40_ and 50_ on HTML pages",
                  "40_ and 50_ on other Resources",
                  "Attacks",
                  "Statuses",
                  "Daily Statuses",
                  "Browsers",
                  "Platforms",
                  "Referers",
                  "IPs",
                  "Geolocation",
                  "Streaks",
                  "Command Invocation",
                  "Performance"
            ].each do |item| %>
                  <li class="nav-item">
                    <a href="#<%= item.downcase.gsub(' ', '-') %>" data-close><%= item %></a>
              </li>
            <% end %>
          </ul>

          <p>
            Generated by
            <a href="https://github.com/avillafiorita/log_sense">LogSense</a> <br />
            on <%= DateTime.now.strftime("%Y-%m-%d %H:%M") %>.<br />
            <a href='https://db-ip.com'>IP Geolocation by DB-IP</a>
          </p>
        </nav>
      </div>
      <div class="off-canvas-content grid-container grid-x fluid" data-off-canvas-content>
        <div data-sticky-container>
          <div class="sticky" data-sticky data-margin-top="0">
            <div class="contents-button">
              <i id="hamburger" class="fi-list" data-toggle="offCanvas"></i>
            </div>
          </div>
        </div>

        <section class="main-section">
          <h1><%= options[:title] || "Log Sense: #{data[:log_file]}" %></h1>

          <p><b>Input File:</b>  <%= (data[:log_file] || "stdin") %></p>

          <div class="grid-x grid-margin-x">
            <article class="card small-12 large-6 cell">
              <div class="card-divider">
                <h2 id="summary">Summary</h2>
              </div>
              <div class="card-section">
                <%= render "summary.html.erb", data: data %>
              </div>
            </article>

            <article class="card cell small-12 large-6">
              <div class="card-divider">
                <h2 id="log-structure">Log Structure</h2>
              </div>
              <div class="card-section">
                <%= render "log_structure.html.erb", data: data %>
              </div>
            </article>
          </div>

          <% @reports = [
            { title: "Daily Distribution",
              header: ["Day", "DOW", "Hits", "Visits", "Size"],
              rows: data[:daily_distribution],
              vega_spec: {
                "layer": [
                  {
                    "mark": {
                      "type": "line",
                      "point": {
                        "filled": false,
                        "fill": "white"
                      }
                    },
                    "encoding": {
                      "y": {"field": "Hits", "type": "quantitative"}
                    }
                  },
                  {
                    "mark": {
                      "type": "text",
                      "color": "#3E5772",
                      "align": "middle",
                      "baseline": "top",
                      "dx": -10,
                      "yOffset": -15
                    },
                    "encoding": {
                      "text": {"field": "Hits", "type": "quantitative"},
                      "y": {"field": "Hits", "type": "quantitative"}
                    }
                  },

                  {
                    "mark": {
                      "type": "line",
                      "color": "#A52A2A",
                      "point": {
                        "color": "#A52A2A",
                        "filled": false,
                        "fill": "white",
                      }
                    },
                    "encoding": {
                      "y": {"field": "Visits", "type": "quantitative"}
                    }
                  },

                  {
                    "mark": {
                      "type": "text",
                      "color": "#A52A2A",
                      "align": "middle",
                      "baseline": "top",
                      "dx": -10,
                      "yOffset": -15
                    },
                    "encoding": {
                      "text": {"field": "Visits", "type": "quantitative"},
                      "y": {"field": "Visits", "type": "quantitative"}
                    }
                  },
                  
                ],
                "encoding": {
                  "x": {"field": "Day", "type": "temporal"},
                }
              }
              
            },
            { title: "Time Distribution",
              header: ["Hour", "Hits", "Visits", "Size"],
              rows: data[:time_distribution],
              vega_spec: {
                "layer": [
                  {
                    "mark": "bar"
                  },
                  {
                    "mark": {
                      "type": "text",
                      "align": "middle",
                      "baseline": "top",
                      "dx": -10,
                      "yOffset": -15
                    },
                    "encoding": {
                      "text": {"field": "Hits", "type": "quantitative"},
                      "y": {"field": "Hits", "type": "quantitative"}
                    }
                  },
                ],
                "encoding": {
                  "x": {"field": "Hour", "type": "nominal"},
                  "y": {"field": "Hits", "type": "quantitative"}
                }
              }
            },
            { title: "20_ and 30_ on HTML pages",
              header: ["Path", "Hits", "Visits", "Size", "Status"],
              rows: data[:most_requested_pages],
              datatable_options: "columnDefs: [{ width: \"40%\", targets: 0 } ]"
            },
            { title: "20_ and 30_ on other resources",
              header: ["Path", "Hits", "Visits", "Size", "Status"],
              rows: data[:most_requested_resources],
              datatable_options: "columnDefs: [{ width: \"40%\", targets: 0 } ]"
            },
            { title: "40_ and 50_x on HTML pages",
              header: ["Path", "Hits", "Visits", "Status"],
              rows: data[:missed_pages],
              datatable_options: "columnDefs: [{ width: \"40%\", targets: 0 } ]"
            },
            { title: "40_ and 50_ on other resources",
              header: ["Path", "Hits", "Visits", "Status"],
              rows: data[:missed_resources],
              datatable_options: "columnDefs: [{ width: \"40%\", targets: 0 } ]"
            },
            { title: "Attacks",
              header: ["Path", "Hits", "Visits", "Status"],
              rows: data[:attacks],
              col: "small-12 cell",
              datatable_options: "columnDefs: [{ width: \"40%\", targets: 0 } ]"
            },
            { title: "Statuses",
              header: ["Status", "Count"],
              rows: data[:statuses],
              vega_spec: {
                "mark": "bar",
                "encoding": {
                  "x": {"field": "Status", "type": "nominal"},
                  "y": {"field": "Count", "type": "quantitative"}
                }
              }
            },
            { title: "Daily Statuses",
              header: ["Date", "S_2xx", "S_3xx", "S_4xx"],
              rows: data[:statuses_by_day],
              vega_spec: {
                "transform": [ {"fold": ["S_2xx", "S_3xx", "S_4xx" ] }],
                "mark": "bar",
                "encoding": {
                  "x": {
                    "field": "Date",
                    "type": "ordinal",
                    "timeUnit": "day", 
                  },
                  "y": {
                    "aggregate": "sum",
                    "field": "value",
                    "type": "quantitative"
                  },
                  "color": {
                    "field": "key",
                    "type": "nominal",
                    "scale": {
                      "domain": ["S_2xx", "S_3xx", "S_4xx"],
                      "range": ["#228b22", "#ff8c00", "#a52a2a"]
                    },
                  }
                }
              }
            },
            { title: "Browsers",
              header: ["Browser", "Hits", "Visits", "Size"],
              rows: data[:browsers],
              vega_spec: {
                "layer": [
                  { "mark": "bar" },
                  {
                    "mark": {
                      "type": "text",
                      "align": "middle",
                      "baseline": "top",
                      "dx": -10,
                      "yOffset": -15
                    },
                    "encoding": {
                      "text": {"field": "Hits", "type": "quantitative"},
                    }
                  },
                ],
                "encoding": {
                  "x": {"field": "Browser", "type": "nominal"},
                  "y": {"field": "Hits", "type": "quantitative"}
                }
              }
            },
            { title: "Platforms",
              header: ["Platform", "Hits", "Visits", "Size"],
              rows: data[:platforms],
              vega_spec: {
                "layer": [
                  { "mark": "bar" },
                  {
                    "mark": {
                      "type": "text",
                      "align": "middle",
                      "baseline": "top",
                      "dx": -10,
                      "yOffset": -15
                    },
                    "encoding": {
                      "text": {"field": "Hits", "type": "quantitative"},
                    }
                  },
                ],
                "encoding": {
                  "x": {"field": "Platform", "type": "nominal"},
                  "y": {"field": "Hits", "type": "quantitative"}
                }
              }
            },
            { title: "IPs", header: ["IPs", "Hits", "Visits", "Size", "Country"], rows: data[:ips] },
            { title: "Referers", header: ["Referers", "Hits", "Visits", "Size"], rows: data[:referers], col: "small-12 cell" },
          ]
          %>
          <div class="grid-x grid-margin-x">
            <% @reports.each_with_index do |report, index| %>
              <article class="card cell <%= report[:col] || "small-12 large-6" %>" >
                <div class="card-divider">
                  <h2 id="<%= report[:title].downcase.gsub(' ', '-') %>">
                    <%= report[:title] %>
                  </h2>
                </div>
                <%= render "report_data.html.erb", report: report, index: index %>
                <% if report[:vega_spec] %>
                  <div id="<%= "plot-#{index}" %>"></div>
                  <script>
                   plot_spec_<%= index %> = Object.assign(
                     <%= report[:vega_spec].to_json %>,
                     { "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                       width: "container",
                       description: "<%= report[:title] %>",
                       data: {
                         values: data_<%= index %>
                       },
                   });
                   vegaEmbed('#<%= "plot-#{index}"%>', plot_spec_<%= index %>);
                  </script>
                <% end %>

                <div class="card-section">
                  <%= render "output_table.html.erb", report: report, index: index %>
                </div>
              </article>
            <% end %>
          </div>

          <article class="card">
            <div class="card-divider">
              <h2 id="geolocation">Geolocation</h2>
            </div>
            <div class="card-section">
              <table id="geolocation-table" class="table unstriped">
                <thead>
                  <tr>
                    <th>Country Code</th>
                    <th>Total Hits</th>
                    <th>Total Visits</th>
                    <th>IPs</th>
                  </tr>              
                </thead>
                <tbody>
                  <%# IP, Hits, Visits Size, Country%>
                  <% data[:ips].group_by { |x| x[4] }.each do |k, v| %>
                    <tr>
                      <td class="country"><%= k %></td>
                      <td class="total-hits"><%= v.map { |x| x[1] }.inject(&:+) %></td>
                      <td class="total-visits"><%= v.map { |x| x[2] }.inject(&:+) %></td>
                      <td class="ips">
                        <%= v.map { |x| "<a href=\"https://whatismyipaddress.com/ip/#{x[0]}\">#{x[0]}</a>" }.join(", ") %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </article>

          <article class="card">
            <div class="card-divider">
              <h2 id="streaks">Streaks</h2>
            </div>
            <div class="card-section">
              <table id="streaks-table" class="table data-table streaks">
                <thead>
                  <tr>
                    <th>IP</th>
                    <th>
                      <div class="grid-x grid-margin-x">
                        <div class="small-2 cell">
                          Day
                        </div>
                        <div class="small-10 cell">
                          Resources
                        </div>
                      </div>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <% data[:streaks].group_by(&:first).each do |ip, date_urls| %>
                    <tr>
                      <td class="ip">
                        <a href="https://whatismyipaddress.com/ip/<%= ip %>"><%= ip %></a>
                      </td>
                      <td class="streaks">
                        <div class="grid-x grid-margin-x">
                          <% date_urls.group_by { |x| x[1] }.each do |date, urls| %>
                            <div class="small-12 medium-1 cell">
                              <span class="date"><%= date %></span>
                            </div>
                            <div class="small-12 medium-5 cell">
                              <span class="res-title">HTML:</span>
                              <% unique_with_count = urls.map { |x| x[2] }.compact.group_by{|e| e}.map{|k, v| [k, v.length]} %>
                              <ul class="no-bullet">
                                <% unique_with_count.select { |x| x[0].match /.*\.html?/ }.each do |url| %>
                                  <li>[<%= url[1] %>] <%= Emitter::escape_javascript url[0] %></li>
                                <% end %>
                              </ul>
                            </div>                              
                            <div class=" small-12 medium-5 cell">
                              <span class="res-title">Other Resources:</span>
                              <ul class="no-bullet">
                                <% unique_with_count.select { |x| x[0] and ! x[0].match /.*\.html?/ }.each do |url| %>
                                  <li>[<%= url[1] %>] <%= Emitter::escape_javascript url[0] %></li>
                                <% end %>
                              </ul>
                            </div>
                          <% end %>
                        </div>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </article>

          <div class="grid-x grid-margin-x">
            <div class="cell small-12 large-6">
              <article>
                <h2 id="command-invocation">Command Invocation</h2>

                <%= render "command_invocation.html.erb", data: data, options: options %>
              </article>
            </div>

            <div class="small-12 large-6 cell">
              <article>
                <h2 id="performance"> Performance</h2>

                <%=  render "performance.html.erb", data: data %>
              </article>
            </div>
          </div>
        </section>
      </div>

      <script type="text/javascript" src="js/vendor/what-input.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>    
      <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/foundation-sites@6.7.4/dist/js/foundation.min.js" crossorigin="anonymous"></script>
      <script>
       $(document).foundation();

       $(document).ready(function () {
         $('.data-table').each(function () {
           $(this).DataTable();
         });
       });
      </script>
    </div>
  </body>
</html>
